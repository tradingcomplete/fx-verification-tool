<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Finder - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .sync-status {
            text-align: center;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 20px;
        }
        .sync-status.connected {
            background: #e8f5e9;
            color: #4CAF50;
        }
        .sync-status.disconnected {
            background: #ffebee;
            color: #f44336;
        }
        .sync-status.syncing {
            background: #fff3e0;
            color: #FF9800;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h3 {
            color: #666;
            margin-top: 20px;
        }
        
        /* ãƒ†ãƒ¼ãƒé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .theme-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
        }
        .theme-selector h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
            margin-top: 0;
        }
        .theme-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .theme-select-row select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }
        .theme-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }
        .theme-btn:hover {
            transform: scale(1.05);
        }
        .theme-btn.new {
            background: #4CAF50;
            color: white;
        }
        .theme-btn.edit {
            background: #FF9800;
            color: white;
        }
        .theme-btn.delete {
            background: #f44336;
            color: white;
        }
        
        /* ãƒ«ãƒ¼ãƒ«è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .rule-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .delete-btn {
            background-color: #f44336;
            padding: 8px 16px;
            font-size: 14px;
        }
        .delete-btn:hover {
            background-color: #da190b;
        }
        .export-btn {
            background-color: #2196F3;
        }
        .export-btn:hover {
            background-color: #0b7dda;
        }
        .report-btn {
            background-color: #FF9800;
        }
        .report-btn:hover {
            background-color: #e68900;
        }
        
        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .input-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #2196F3;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            font-size: 18px;
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .radio-group label:hover {
            background-color: #f0f0f0;
        }
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        .radio-group label.selected-win {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }
        .radio-group label.selected-lose {
            border-color: #f44336;
            background-color: #ffebee;
        }
        .radio-group label.selected-skip {
            border-color: #FF9800;
            background-color: #fff3e0;
        }
        
        /* ã‚¯ã‚¤ãƒƒã‚¯çµ±è¨ˆ */
        .quick-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            font-size: 18px;
        }
        .quick-stat {
            font-weight: bold;
        }
        
        /* çµ±è¨ˆãƒœãƒƒã‚¯ã‚¹ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4CAF50;
        }
        .stat-box h3 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 12px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .positive { color: #4CAF50; }
        .negative { color: #f44336; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .result-win { color: #4CAF50; font-weight: bold; }
        .result-lose { color: #f44336; font-weight: bold; }
        .skip-reason { color: #FF9800; font-style: italic; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        
        /* ãƒ¬ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .report-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .report-section h4 {
            margin-top: 0;
            color: #555;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .report-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .report-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .report-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        /* ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .note-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff9c4;
            border-radius: 8px;
            border-left: 4px solid #fbc02d;
        }
        
        /* ãƒ†ãƒ¼ãƒæƒ…å ±è¡¨ç¤º */
        .current-theme-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .current-theme-info h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        .theme-detail {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        /* é€£å‹é€£æ•—è©³ç´° */
        .streak-details {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .streak-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .streak-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .form-row { flex-direction: column; }
            .radio-group { flex-direction: column; gap: 10px; }
            .theme-select-row { flex-direction: column; }
            .theme-select-row select { width: 100%; }
            .quick-stats { flex-direction: column; gap: 10px; text-align: center; }
            .stat-value { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Edge Finder</h1>
        <p class="subtitle">FXæ‰‹æ³•æ¤œè¨¼ãƒ„ãƒ¼ãƒ« - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºç‰ˆ</p>
        <div style="text-align: center;">
            <span id="sync-status" class="sync-status disconnected">â— æ¥ç¶šç¢ºèªä¸­...</span>
        </div>

        <!-- ãƒ†ãƒ¼ãƒé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="theme-selector">
            <h2 style="margin-top:0;">ğŸ“Š æ¤œè¨¼ãƒ†ãƒ¼ãƒé¸æŠ</h2>
            <div class="theme-select-row">
                <select id="theme-select" onchange="onThemeChange()">
                    <option value="">-- ãƒ†ãƒ¼ãƒã‚’é¸æŠ --</option>
                </select>
                <button class="theme-btn new" onclick="showNewThemeModal()">ï¼‹ æ–°è¦ä½œæˆ</button>
                <button class="theme-btn edit" onclick="showEditThemeModal()" id="edit-theme-btn" disabled>ç·¨é›†</button>
                <button class="theme-btn delete" onclick="deleteCurrentTheme()" id="delete-theme-btn" disabled>å‰Šé™¤</button>
            </div>
        </div>

        <!-- ç¾åœ¨ã®ãƒ†ãƒ¼ãƒæƒ…å ± -->
        <div id="current-theme-info" class="current-theme-info" style="display: none;">
            <h3 id="theme-title">ãƒ†ãƒ¼ãƒå</h3>
            <div class="theme-detail"><strong>é€šè²¨ãƒšã‚¢:</strong> <span id="theme-pair">-</span></div>
            <div class="theme-detail"><strong>æ¤œè¨¼æœŸé–“:</strong> <span id="theme-period">-</span></div>
            <div class="theme-detail"><strong>æ™‚é–“è¶³:</strong> ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤æ–­ <span id="theme-trend-tf">-</span> / ãƒˆãƒ¬ãƒ¼ãƒ‰ <span id="theme-trade-tf">-</span></div>
            <div class="theme-detail"><strong>ã‚¨ãƒ³ãƒˆãƒªãƒ¼:</strong> <span id="theme-entry-rule">-</span></div>
            <div class="theme-detail"><strong>åˆ©ç¢º:</strong> <span id="theme-tp-rule">-</span></div>
            <div class="theme-detail"><strong>æåˆ‡:</strong> <span id="theme-sl-rule">-</span></div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="input-section" id="input-section" style="display: none;">
            <h2 style="margin-top: 0;">æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
            
            <div class="form-group">
                <label>çµæœã‚’é¸æŠ</label>
                <div class="radio-group">
                    <label id="label-win">
                        <input type="radio" name="result" value="win" onchange="toggleFields()">
                        å‹ã¡
                    </label>
                    <label id="label-lose">
                        <input type="radio" name="result" value="lose" onchange="toggleFields()">
                        è² ã‘
                    </label>
                    <label id="label-skip">
                        <input type="radio" name="result" value="skip" onchange="toggleFields()">
                        è¦‹é€ã‚Š
                    </label>
                </div>
            </div>

            <div id="pips-field" style="display: none;">
                <div class="form-group">
                    <label for="pips">ç²å¾—/æå¤± pipsï¼ˆãƒ—ãƒ©ã‚¹ã®å€¤ã§å…¥åŠ›ï¼‰</label>
                    <input type="number" id="pips" min="0" step="0.1" placeholder="150" onkeypress="handleEnterKey(event)">
                </div>
            </div>

            <div id="skip-reason-field" style="display: none;">
                <div class="form-group">
                    <label for="skip-reason">è¦‹é€ã‚Šç†ç”±</label>
                    <input type="text" id="skip-reason" placeholder="ä¾‹ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ãŒä¸æ˜ç¢ºã ã£ãŸ" onkeypress="handleSkipEnterKey(event)">
                </div>
            </div>

            <button onclick="addRecord()" id="add-button">è¨˜éŒ²ã‚’è¿½åŠ </button>
            
            <div class="quick-stats">
                <span class="quick-stat">ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼š<span id="quick-total">0</span>å›</span>
                <span class="quick-stat">å‹ç‡ï¼š<span id="quick-winrate">0</span>%</span>
                <span class="quick-stat">æç›Šï¼š<span id="quick-pips">0</span>pips</span>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div id="stats-section" style="display: none;">
            <h2>æ¤œè¨¼çµæœçµ±è¨ˆ</h2>
            <div class="stats">
                <div class="stat-box">
                    <h3>ç·æ¤œè¨¼å›æ•°</h3>
                    <div class="stat-value" id="total-count">0</div>
                </div>
                <div class="stat-box">
                    <h3>ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°</h3>
                    <div class="stat-value" id="trade-count">0</div>
                </div>
                <div class="stat-box">
                    <h3>å‹ç‡</h3>
                    <div class="stat-value" id="win-rate">0%</div>
                </div>
                <div class="stat-box">
                    <h3>å‹æ•—</h3>
                    <div class="stat-value" id="win-lose">0å‹0æ•—</div>
                </div>
                <div class="stat-box">
                    <h3>ç·æç›Š</h3>
                    <div class="stat-value" id="total-pips">0 pips</div>
                </div>
                <div class="stat-box">
                    <h3>æœŸå¾…å€¤</h3>
                    <div class="stat-value" id="expected-value">0 pips</div>
                </div>
            </div>
        </div>

        <!-- è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div id="records-section" style="display: none;">
            <h2>æ¤œè¨¼è¨˜éŒ²</h2>
            <div class="action-buttons">
                <button class="report-btn" onclick="showDetailedReport()">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º</button>
                <button class="export-btn" onclick="exportToCSV()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="delete-btn" onclick="clearAllData()">ã“ã®ãƒ†ãƒ¼ãƒã®å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>çµæœ</th>
                            <th>pips</th>
                            <th>ç†ç”±</th>
                            <th>å‰Šé™¤</th>
                        </tr>
                    </thead>
                    <tbody id="records-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="initial-message" class="note-section">
            <p><strong>ğŸ“Œ ä½¿ã„æ–¹ï¼š</strong></p>
            <ul>
                <li>ã¾ãšã€Œï¼‹ æ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã§æ¤œè¨¼ãƒ†ãƒ¼ãƒã‚’ä½œæˆ</li>
                <li>ãƒ†ãƒ¼ãƒã‚’é¸æŠã™ã‚‹ã¨æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›ãŒã§ãã¾ã™</li>
                <li>ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™</li>
                <li>è¤‡æ•°ã®ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆã¦ç®¡ç†ã§ãã¾ã™</li>
            </ul>
        </div>
    </div>

    <!-- æ–°è¦ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="newThemeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewThemeModal()">&times;</span>
            <h2>æ–°è¦ãƒ†ãƒ¼ãƒä½œæˆ</h2>
            <div class="form-group">
                <label for="new-theme-name">ãƒ†ãƒ¼ãƒå *</label>
                <input type="text" id="new-theme-name" placeholder="ä¾‹ï¼šç§»å‹•å¹³å‡ç·šæŠ¼ã—ç›®è²·ã„">
            </div>
            <div class="form-group">
                <label for="new-pair">é€šè²¨ãƒšã‚¢</label>
                <input type="text" id="new-pair" placeholder="ä¾‹ï¼šUSDJPY">
            </div>
            <div class="form-group">
                <label for="new-period">æ¤œè¨¼æœŸé–“</label>
                <input type="text" id="new-period" placeholder="ä¾‹ï¼š2022.1-2022.12">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-trend-tf">ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤æ–­è¶³</label>
                    <input type="text" id="new-trend-tf" placeholder="ä¾‹ï¼š4H">
                </div>
                <div class="form-group">
                    <label for="new-trade-tf">ãƒˆãƒ¬ãƒ¼ãƒ‰è¶³</label>
                    <input type="text" id="new-trade-tf" placeholder="ä¾‹ï¼š1H">
                </div>
            </div>
            <div class="form-group">
                <label for="new-entry-rule">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ«ãƒ¼ãƒ«</label>
                <textarea id="new-entry-rule" placeholder="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶ã‚’è©³ã—ãè¨˜å…¥"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-tp-rule">åˆ©ç¢ºãƒ«ãƒ¼ãƒ«</label>
                    <input type="text" id="new-tp-rule" placeholder="ä¾‹ï¼š+100pips / ç›´è¿‘é«˜å€¤">
                </div>
                <div class="form-group">
                    <label for="new-sl-rule">æåˆ‡ãƒ«ãƒ¼ãƒ«</label>
                    <input type="text" id="new-sl-rule" placeholder="ä¾‹ï¼š-30pips / ã‚¨ãƒ³ãƒˆãƒªãƒ¼è¶³å®‰å€¤">
                </div>
            </div>
            <button onclick="createNewTheme()">ãƒ†ãƒ¼ãƒã‚’ä½œæˆ</button>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editThemeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditThemeModal()">&times;</span>
            <h2>ãƒ†ãƒ¼ãƒã‚’ç·¨é›†</h2>
            <div class="form-group">
                <label for="edit-theme-name">ãƒ†ãƒ¼ãƒå *</label>
                <input type="text" id="edit-theme-name">
            </div>
            <div class="form-group">
                <label for="edit-pair">é€šè²¨ãƒšã‚¢</label>
                <input type="text" id="edit-pair">
            </div>
            <div class="form-group">
                <label for="edit-period">æ¤œè¨¼æœŸé–“</label>
                <input type="text" id="edit-period">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-trend-tf">ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤æ–­è¶³</label>
                    <input type="text" id="edit-trend-tf">
                </div>
                <div class="form-group">
                    <label for="edit-trade-tf">ãƒˆãƒ¬ãƒ¼ãƒ‰è¶³</label>
                    <input type="text" id="edit-trade-tf">
                </div>
            </div>
            <div class="form-group">
                <label for="edit-entry-rule">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ«ãƒ¼ãƒ«</label>
                <textarea id="edit-entry-rule"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-tp-rule">åˆ©ç¢ºãƒ«ãƒ¼ãƒ«</label>
                    <input type="text" id="edit-tp-rule">
                </div>
                <div class="form-group">
                    <label for="edit-sl-rule">æåˆ‡ãƒ«ãƒ¼ãƒ«</label>
                    <input type="text" id="edit-sl-rule">
                </div>
            </div>
            <button onclick="updateTheme()">æ›´æ–°ã™ã‚‹</button>
        </div>
    </div>

    <!-- è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReportModal()">&times;</span>
            <h2>æ¤œè¨¼çµæœè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <div id="detailed-report"></div>
        </div>
    </div>

    <script>
        // ===========================================
        // è¨­å®š
        // ===========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwm1kuPqeQoWhF1cHzFEcLPnBpXG8Vyj9qEqAJY5GNT1liInMHItfSp41m3vhP2Sgmm/exec';
        
        // ===========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ===========================================
        let themes = [];
        let records = [];
        let currentTheme = null;

        // ===========================================
        // åˆæœŸåŒ–
        // ===========================================
        window.onload = async function() {
            await loadThemes();
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        };

        // ===========================================
        // APIé€šä¿¡
        // ===========================================
        async function apiGet(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (const [key, value] of Object.entries(params)) {
                url.searchParams.append(key, value);
            }
            
            try {
                const response = await fetch(url.toString());
                return await response.json();
            } catch (error) {
                console.error('API GET Error:', error);
                updateSyncStatus('disconnected', 'â— æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                return { success: false, error: error.message };
            }
        }

        async function apiPost(action, data) {
            try {
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    redirect: 'follow'
                });
                return await response.json();
            } catch (error) {
                console.error('API POST Error:', error);
                updateSyncStatus('disconnected', 'â— æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                return { success: false, error: error.message };
            }
        }

        // ===========================================
        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        // ===========================================
        function updateSyncStatus(status, text) {
            const el = document.getElementById('sync-status');
            el.className = 'sync-status ' + status;
            el.textContent = text;
        }

        // ===========================================
        // ãƒ†ãƒ¼ãƒç®¡ç†
        // ===========================================
        async function loadThemes() {
            updateSyncStatus('syncing', 'â— èª­ã¿è¾¼ã¿ä¸­...');
            const result = await apiGet('getThemes');
            
            if (result.success) {
                themes = result.data || [];
                updateThemeSelect();
                updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
            } else {
                alert('ãƒ†ãƒ¼ãƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
                updateSyncStatus('disconnected', 'â— æ¥ç¶šã‚¨ãƒ©ãƒ¼');
            }
        }

        function updateThemeSelect() {
            const select = document.getElementById('theme-select');
            select.innerHTML = '<option value="">-- ãƒ†ãƒ¼ãƒã‚’é¸æŠ --</option>';
            
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.themeId;
                option.textContent = theme.themeName + (theme.pair ? ` (${theme.pair})` : '');
                select.appendChild(option);
            });
        }

        async function onThemeChange() {
            const themeId = document.getElementById('theme-select').value;
            
            if (!themeId) {
                currentTheme = null;
                hideThemeSections();
                document.getElementById('edit-theme-btn').disabled = true;
                document.getElementById('delete-theme-btn').disabled = true;
                document.getElementById('initial-message').style.display = 'block';
                return;
            }
            
            currentTheme = themes.find(t => t.themeId === themeId);
            document.getElementById('edit-theme-btn').disabled = false;
            document.getElementById('delete-theme-btn').disabled = false;
            document.getElementById('initial-message').style.display = 'none';
            
            displayCurrentThemeInfo();
            showThemeSections();
            await loadRecords();
        }

        function displayCurrentThemeInfo() {
            if (!currentTheme) return;
            
            document.getElementById('theme-title').textContent = currentTheme.themeName || 'ç„¡é¡Œã®ãƒ†ãƒ¼ãƒ';
            document.getElementById('theme-pair').textContent = currentTheme.pair || '-';
            document.getElementById('theme-period').textContent = currentTheme.period || '-';
            document.getElementById('theme-trend-tf').textContent = currentTheme.trendTimeframe || '-';
            document.getElementById('theme-trade-tf').textContent = currentTheme.tradeTimeframe || '-';
            document.getElementById('theme-entry-rule').textContent = currentTheme.entryRule || '-';
            document.getElementById('theme-tp-rule').textContent = currentTheme.tpRule || '-';
            document.getElementById('theme-sl-rule').textContent = currentTheme.slRule || '-';
            
            document.getElementById('current-theme-info').style.display = 'block';
        }

        function showThemeSections() {
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('stats-section').style.display = 'block';
            document.getElementById('records-section').style.display = 'block';
        }

        function hideThemeSections() {
            document.getElementById('current-theme-info').style.display = 'none';
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('stats-section').style.display = 'none';
            document.getElementById('records-section').style.display = 'none';
        }

        // ===========================================
        // æ–°è¦ãƒ†ãƒ¼ãƒ
        // ===========================================
        function showNewThemeModal() {
            document.getElementById('newThemeModal').style.display = 'block';
        }

        function closeNewThemeModal() {
            document.getElementById('newThemeModal').style.display = 'none';
            clearNewThemeForm();
        }

        function clearNewThemeForm() {
            document.getElementById('new-theme-name').value = '';
            document.getElementById('new-pair').value = '';
            document.getElementById('new-period').value = '';
            document.getElementById('new-trend-tf').value = '';
            document.getElementById('new-trade-tf').value = '';
            document.getElementById('new-entry-rule').value = '';
            document.getElementById('new-tp-rule').value = '';
            document.getElementById('new-sl-rule').value = '';
        }

        async function createNewTheme() {
            const themeName = document.getElementById('new-theme-name').value.trim();
            
            if (!themeName) {
                alert('ãƒ†ãƒ¼ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            updateSyncStatus('syncing', 'â— ä¿å­˜ä¸­...');
            
            const data = {
                themeName: themeName,
                pair: document.getElementById('new-pair').value.trim(),
                period: document.getElementById('new-period').value.trim(),
                trendTimeframe: document.getElementById('new-trend-tf').value.trim(),
                tradeTimeframe: document.getElementById('new-trade-tf').value.trim(),
                entryRule: document.getElementById('new-entry-rule').value.trim(),
                tpRule: document.getElementById('new-tp-rule').value.trim(),
                slRule: document.getElementById('new-sl-rule').value.trim()
            };
            
            const result = await apiPost('addTheme', data);
            
            if (result.success) {
                closeNewThemeModal();
                await loadThemes();
                document.getElementById('theme-select').value = result.themeId;
                await onThemeChange();
                alert('ãƒ†ãƒ¼ãƒã‚’ä½œæˆã—ã¾ã—ãŸï¼');
            } else {
                alert('ãƒ†ãƒ¼ãƒã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        // ===========================================
        // ãƒ†ãƒ¼ãƒç·¨é›†
        // ===========================================
        function showEditThemeModal() {
            if (!currentTheme) return;
            
            document.getElementById('edit-theme-name').value = currentTheme.themeName || '';
            document.getElementById('edit-pair').value = currentTheme.pair || '';
            document.getElementById('edit-period').value = currentTheme.period || '';
            document.getElementById('edit-trend-tf').value = currentTheme.trendTimeframe || '';
            document.getElementById('edit-trade-tf').value = currentTheme.tradeTimeframe || '';
            document.getElementById('edit-entry-rule').value = currentTheme.entryRule || '';
            document.getElementById('edit-tp-rule').value = currentTheme.tpRule || '';
            document.getElementById('edit-sl-rule').value = currentTheme.slRule || '';
            
            document.getElementById('editThemeModal').style.display = 'block';
        }

        function closeEditThemeModal() {
            document.getElementById('editThemeModal').style.display = 'none';
        }

        async function updateTheme() {
            if (!currentTheme) return;
            
            const themeName = document.getElementById('edit-theme-name').value.trim();
            
            if (!themeName) {
                alert('ãƒ†ãƒ¼ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            updateSyncStatus('syncing', 'â— ä¿å­˜ä¸­...');
            
            const data = {
                themeId: currentTheme.themeId,
                themeName: themeName,
                pair: document.getElementById('edit-pair').value.trim(),
                period: document.getElementById('edit-period').value.trim(),
                trendTimeframe: document.getElementById('edit-trend-tf').value.trim(),
                tradeTimeframe: document.getElementById('edit-trade-tf').value.trim(),
                entryRule: document.getElementById('edit-entry-rule').value.trim(),
                tpRule: document.getElementById('edit-tp-rule').value.trim(),
                slRule: document.getElementById('edit-sl-rule').value.trim()
            };
            
            const result = await apiPost('updateTheme', data);
            
            if (result.success) {
                closeEditThemeModal();
                await loadThemes();
                document.getElementById('theme-select').value = currentTheme.themeId;
                await onThemeChange();
                alert('ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
                alert('ãƒ†ãƒ¼ãƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        // ===========================================
        // ãƒ†ãƒ¼ãƒå‰Šé™¤
        // ===========================================
        async function deleteCurrentTheme() {
            if (!currentTheme) return;
            
            if (!confirm(`ãƒ†ãƒ¼ãƒã€Œ${currentTheme.themeName}ã€ã¨ãã®å…¨ã¦ã®æ¤œè¨¼è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            updateSyncStatus('syncing', 'â— å‰Šé™¤ä¸­...');
            
            const result = await apiPost('deleteTheme', { themeId: currentTheme.themeId });
            
            if (result.success) {
                await loadThemes();
                document.getElementById('theme-select').value = '';
                await onThemeChange();
                alert('ãƒ†ãƒ¼ãƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } else {
                alert('ãƒ†ãƒ¼ãƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        // ===========================================
        // æ¤œè¨¼è¨˜éŒ²
        // ===========================================
        async function loadRecords() {
            if (!currentTheme) return;
            
            updateSyncStatus('syncing', 'â— èª­ã¿è¾¼ã¿ä¸­...');
            
            const result = await apiGet('getRecords', { themeId: currentTheme.themeId });
            
            if (result.success) {
                records = result.data || [];
                updateTable();
                updateStats();
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        function toggleFields() {
            const result = document.querySelector('input[name="result"]:checked');
            const pipsField = document.getElementById('pips-field');
            const skipReasonField = document.getElementById('skip-reason-field');
            
            document.getElementById('label-win').className = '';
            document.getElementById('label-lose').className = '';
            document.getElementById('label-skip').className = '';
            
            if (result) {
                if (result.value === 'win') {
                    document.getElementById('label-win').className = 'selected-win';
                    pipsField.style.display = 'block';
                    skipReasonField.style.display = 'none';
                    document.getElementById('skip-reason').value = '';
                    document.getElementById('pips').focus();
                } else if (result.value === 'lose') {
                    document.getElementById('label-lose').className = 'selected-lose';
                    pipsField.style.display = 'block';
                    skipReasonField.style.display = 'none';
                    document.getElementById('skip-reason').value = '';
                    document.getElementById('pips').focus();
                } else if (result.value === 'skip') {
                    document.getElementById('label-skip').className = 'selected-skip';
                    pipsField.style.display = 'none';
                    skipReasonField.style.display = 'block';
                    document.getElementById('pips').value = '';
                    document.getElementById('skip-reason').focus();
                }
            }
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                addRecord();
            }
        }

        function handleSkipEnterKey(event) {
            if (event.key === 'Enter') {
                addRecord();
            }
        }

        async function addRecord() {
            if (!currentTheme) {
                alert('ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const result = document.querySelector('input[name="result"]:checked');
            const pips = document.getElementById('pips').value;
            const skipReason = document.getElementById('skip-reason').value;

            if (!result) {
                alert('çµæœã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if ((result.value === 'win' || result.value === 'lose') && !pips) {
                alert('pipsã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (result.value === 'skip' && !skipReason) {
                alert('è¦‹é€ã‚Šç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            let pipsValue = 0;
            if (result.value === 'win') {
                pipsValue = parseFloat(pips);
            } else if (result.value === 'lose') {
                pipsValue = -Math.abs(parseFloat(pips));
            }

            updateSyncStatus('syncing', 'â— ä¿å­˜ä¸­...');

            const data = {
                themeId: currentTheme.themeId,
                result: result.value,
                pips: pipsValue,
                skipReason: skipReason || ''
            };

            const apiResult = await apiPost('addRecord', data);

            if (apiResult.success) {
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                document.getElementById('skip-reason').value = '';
                document.getElementById('pips').value = '';
                document.getElementById('pips-field').style.display = 'none';
                document.getElementById('skip-reason-field').style.display = 'none';
                document.getElementById('label-win').className = '';
                document.getElementById('label-lose').className = '';
                document.getElementById('label-skip').className = '';

                await loadRecords();
            } else {
                alert('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + apiResult.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        async function deleteRecord(recordId) {
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            updateSyncStatus('syncing', 'â— å‰Šé™¤ä¸­...');
            
            const result = await apiPost('deleteRecord', { recordId: recordId });
            
            if (result.success) {
                await loadRecords();
            } else {
                alert('è¨˜éŒ²ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        async function clearAllData() {
            if (!currentTheme) return;
            
            if (!confirm(`ãƒ†ãƒ¼ãƒã€Œ${currentTheme.themeName}ã€ã®å…¨ã¦ã®æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            updateSyncStatus('syncing', 'â— å‰Šé™¤ä¸­...');
            
            const result = await apiPost('clearRecords', { themeId: currentTheme.themeId });
            
            if (result.success) {
                await loadRecords();
                alert('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
            
            updateSyncStatus('connected', 'â— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ¥ç¶šä¸­');
        }

        // ===========================================
        // è¡¨ç¤ºæ›´æ–°
        // ===========================================
        function getSkipReasonText(reason) {
            return reason || '-';
        }

        function updateTable() {
            const tbody = document.getElementById('records-body');
            tbody.innerHTML = '';

            records.forEach((record, index) => {
                const row = tbody.insertRow();
                const pipsValue = parseFloat(record.pips) || 0;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="${record.result === 'win' ? 'result-win' : record.result === 'lose' ? 'result-lose' : ''}">${record.result === 'win' ? 'å‹ã¡' : record.result === 'lose' ? 'è² ã‘' : 'è¦‹é€ã‚Š'}</td>
                    <td class="${pipsValue > 0 ? 'positive' : pipsValue < 0 ? 'negative' : ''}">${pipsValue !== 0 ? pipsValue.toFixed(1) : '-'}</td>
                    <td>${record.skipReason ? `<span class="skip-reason">${getSkipReasonText(record.skipReason)}</span>` : '-'}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${record.recordId}')">å‰Šé™¤</button></td>
                `;
            });
        }

        function updateStats() {
            const totalCount = records.length;
            const trades = records.filter(r => r.result === 'win' || r.result === 'lose');
            const wins = records.filter(r => r.result === 'win');
            const losses = records.filter(r => r.result === 'lose');
            
            const tradeCount = trades.length;
            const winCount = wins.length;
            const lossCount = losses.length;
            const winRate = tradeCount > 0 ? (winCount / tradeCount * 100).toFixed(1) : 0;
            
            const totalPips = trades.reduce((sum, r) => sum + (parseFloat(r.pips) || 0), 0);
            const expectedValue = tradeCount > 0 ? (totalPips / tradeCount).toFixed(1) : 0;

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('trade-count').textContent = tradeCount;
            document.getElementById('win-rate').textContent = winRate + '%';
            document.getElementById('win-lose').textContent = `${winCount}å‹${lossCount}æ•—`;
            document.getElementById('total-pips').textContent = totalPips.toFixed(1) + ' pips';
            document.getElementById('total-pips').className = totalPips >= 0 ? 'stat-value positive' : 'stat-value negative';
            document.getElementById('expected-value').textContent = expectedValue + ' pips';
            document.getElementById('expected-value').className = expectedValue >= 0 ? 'stat-value positive' : 'stat-value negative';
            
            document.getElementById('quick-total').textContent = tradeCount;
            document.getElementById('quick-winrate').textContent = winRate;
            document.getElementById('quick-pips').textContent = totalPips.toFixed(0);
            document.getElementById('quick-pips').style.color = totalPips >= 0 ? '#4CAF50' : '#f44336';
        }

        // ===========================================
        // é€£å‹ãƒ»é€£æ•—è¨ˆç®—
        // ===========================================
        function calculateStreaks() {
            const trades = records.filter(r => r.result === 'win' || r.result === 'lose');
            if (trades.length === 0) return null;

            let currentStreak = 0;
            let maxWinStreak = 0;
            let maxLoseStreak = 0;
            let streakType = '';
            
            const winStreaks = {};
            const loseStreaks = {};
            let currentWinStreak = 0;
            let currentLoseStreak = 0;

            trades.forEach((record, index) => {
                if (record.result === 'win') {
                    if (streakType === 'win') {
                        currentStreak++;
                        currentWinStreak++;
                    } else {
                        if (currentLoseStreak > 0) {
                            loseStreaks[currentLoseStreak] = (loseStreaks[currentLoseStreak] || 0) + 1;
                        }
                        currentStreak = 1;
                        currentWinStreak = 1;
                        currentLoseStreak = 0;
                        streakType = 'win';
                    }
                    maxWinStreak = Math.max(maxWinStreak, currentStreak);
                } else if (record.result === 'lose') {
                    if (streakType === 'lose') {
                        currentStreak++;
                        currentLoseStreak++;
                    } else {
                        if (currentWinStreak > 0) {
                            winStreaks[currentWinStreak] = (winStreaks[currentWinStreak] || 0) + 1;
                        }
                        currentStreak = 1;
                        currentLoseStreak = 1;
                        currentWinStreak = 0;
                        streakType = 'lose';
                    }
                    maxLoseStreak = Math.max(maxLoseStreak, currentStreak);
                }
            });

            if (currentWinStreak > 0) {
                winStreaks[currentWinStreak] = (winStreaks[currentWinStreak] || 0) + 1;
            }
            if (currentLoseStreak > 0) {
                loseStreaks[currentLoseStreak] = (loseStreaks[currentLoseStreak] || 0) + 1;
            }

            return {
                maxWinStreak,
                maxLoseStreak,
                winStreaks,
                loseStreaks
            };
        }

        // ===========================================
        // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
        // ===========================================
        function showDetailedReport() {
            if (!currentTheme) return;
            
            const trades = records.filter(r => r.result === 'win' || r.result === 'lose');
            const wins = records.filter(r => r.result === 'win');
            const losses = records.filter(r => r.result === 'lose');
            const skips = records.filter(r => r.result === 'skip');
            
            const streaks = calculateStreaks();
            
            const totalWinPips = wins.reduce((sum, r) => sum + (parseFloat(r.pips) || 0), 0);
            const totalLossPips = Math.abs(losses.reduce((sum, r) => sum + (parseFloat(r.pips) || 0), 0));
            const netPips = totalWinPips - totalLossPips;
            const avgWin = wins.length > 0 ? (totalWinPips / wins.length) : 0;
            const avgLoss = losses.length > 0 ? (totalLossPips / losses.length) : 0;
            
            let reportHTML = `
                <div class="report-section">
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <div class="report-grid">
                        <div class="report-item">
                            <div class="report-label">æ¤œè¨¼ãƒ†ãƒ¼ãƒ</div>
                            <div class="report-value">${currentTheme.themeName || 'æœªè¨­å®š'}</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">é€šè²¨ãƒšã‚¢</div>
                            <div class="report-value">${currentTheme.pair || 'æœªè¨­å®š'}</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">æ¤œè¨¼æœŸé–“</div>
                            <div class="report-value">${currentTheme.period || 'æœªè¨­å®š'}</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h4>ãƒˆãƒ¬ãƒ¼ãƒ‰æˆç¸¾</h4>
                    <div class="report-grid">
                        <div class="report-item">
                            <div class="report-label">ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°</div>
                            <div class="report-value">${trades.length}å›</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">å‹æ•—</div>
                            <div class="report-value">${wins.length}å‹${losses.length}æ•—</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">å‹ç‡</div>
                            <div class="report-value">${trades.length > 0 ? (wins.length / trades.length * 100).toFixed(1) : 0}%</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h4>æç›Šåˆ†æ</h4>
                    <div class="report-grid">
                        <div class="report-item">
                            <div class="report-label">ç·åˆ©ç›Š</div>
                            <div class="report-value positive">+${totalWinPips.toFixed(0)} pips</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">ç·æå¤±</div>
                            <div class="report-value negative">-${totalLossPips.toFixed(0)} pips</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">ç´”æç›Š</div>
                            <div class="report-value ${netPips >= 0 ? 'positive' : 'negative'}">${netPips >= 0 ? '+' : ''}${netPips.toFixed(0)} pips</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">å¹³å‡åˆ©ç›Š</div>
                            <div class="report-value positive">+${avgWin.toFixed(0)} pips</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">å¹³å‡æå¤±</div>
                            <div class="report-value negative">-${avgLoss.toFixed(0)} pips</div>
                        </div>
                        <div class="report-item">
                            <div class="report-label">ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”</div>
                            <div class="report-value">${avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : '0'}</div>
                        </div>
                    </div>
                </div>
            `;

            if (streaks) {
                reportHTML += `
                    <div class="report-section">
                        <h4>é€£å‹ãƒ»é€£æ•—è¨˜éŒ²</h4>
                        <div class="report-grid">
                            <div class="report-item">
                                <div class="report-label">æœ€å¤§é€£å‹æ•°</div>
                                <div class="report-value positive">${streaks.maxWinStreak}</div>
                            </div>
                            <div class="report-item">
                                <div class="report-label">æœ€å¤§é€£æ•—æ•°</div>
                                <div class="report-value negative">${streaks.maxLoseStreak}</div>
                            </div>
                        </div>
                `;

                if (Object.keys(streaks.winStreaks).length > 0) {
                    const sortedWinStreaks = Object.entries(streaks.winStreaks)
                        .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                        .filter(([streak, count]) => parseInt(streak) > 1);
                    
                    if (sortedWinStreaks.length > 0) {
                        reportHTML += `
                            <div class="streak-details">
                                <h5>é€£å‹ã®è©³ç´°</h5>
                                <ul class="streak-list">
                        `;
                        sortedWinStreaks.forEach(([streak, count]) => {
                            reportHTML += `<li>${streak}é€£å‹: ${count}å›</li>`;
                        });
                        reportHTML += `</ul></div>`;
                    }
                }

                if (Object.keys(streaks.loseStreaks).length > 0) {
                    const sortedLoseStreaks = Object.entries(streaks.loseStreaks)
                        .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                        .filter(([streak, count]) => parseInt(streak) > 1);
                    
                    if (sortedLoseStreaks.length > 0) {
                        reportHTML += `
                            <div class="streak-details">
                                <h5>é€£æ•—ã®è©³ç´°</h5>
                                <ul class="streak-list">
                        `;
                        sortedLoseStreaks.forEach(([streak, count]) => {
                            reportHTML += `<li>${streak}é€£æ•—: ${count}å›</li>`;
                        });
                        reportHTML += `</ul></div>`;
                    }
                }
                
                reportHTML += `</div>`;
            }

            if (skips.length > 0) {
                reportHTML += `
                    <div class="report-section">
                        <h4>è¦‹é€ã‚Šç†ç”±ä¸€è¦§ï¼ˆ${skips.length}å›ï¼‰</h4>
                        <div class="streak-details">
                            <ul class="streak-list">
                `;
                
                skips.forEach((record, index) => {
                    reportHTML += `<li>${index + 1}. ${record.skipReason || '-'}</li>`;
                });
                
                reportHTML += `</ul></div></div>`;
            }

            document.getElementById('detailed-report').innerHTML = reportHTML;
            document.getElementById('reportModal').style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // ===========================================
        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        // ===========================================
        function exportToCSV() {
            if (!currentTheme) return;
            
            if (records.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const trades = records.filter(r => r.result === 'win' || r.result === 'lose');
            const wins = records.filter(r => r.result === 'win');
            const losses = records.filter(r => r.result === 'lose');
            const streaks = calculateStreaks();
            
            const totalWinPips = wins.reduce((sum, r) => sum + (parseFloat(r.pips) || 0), 0);
            const totalLossPips = Math.abs(losses.reduce((sum, r) => sum + (parseFloat(r.pips) || 0), 0));

            let csv = '\uFEFF'; // BOM for Excel
            csv += '=== æ¤œè¨¼è¨­å®š ===\n';
            csv += 'æ¤œè¨¼ãƒ†ãƒ¼ãƒ,' + (currentTheme.themeName || '') + '\n';
            csv += 'é€šè²¨ãƒšã‚¢,' + (currentTheme.pair || '') + '\n';
            csv += 'æ¤œè¨¼æœŸé–“,' + (currentTheme.period || '') + '\n';
            csv += 'ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤æ–­,' + (currentTheme.trendTimeframe || '') + '\n';
            csv += 'ãƒˆãƒ¬ãƒ¼ãƒ‰,' + (currentTheme.tradeTimeframe || '') + '\n';
            csv += 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ«ãƒ¼ãƒ«,"' + (currentTheme.entryRule || '').replace(/"/g, '""') + '"\n';
            csv += 'åˆ©ç¢ºãƒ«ãƒ¼ãƒ«,' + (currentTheme.tpRule || '') + '\n';
            csv += 'æåˆ‡ãƒ«ãƒ¼ãƒ«,' + (currentTheme.slRule || '') + '\n';
            csv += '\n';
            
            csv += '=== æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼ ===\n';
            csv += 'ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°,' + trades.length + 'å›\n';
            csv += 'å‹æ•—,' + wins.length + 'å‹' + losses.length + 'æ•—\n';
            csv += 'å‹ç‡,' + (trades.length > 0 ? (wins.length / trades.length * 100).toFixed(1) : 0) + '%\n';
            csv += 'ç·åˆ©ç›Š,' + totalWinPips.toFixed(0) + ' pips\n';
            csv += 'ç·æå¤±,' + totalLossPips.toFixed(0) + ' pips\n';
            csv += 'ç´”æç›Š,' + (totalWinPips - totalLossPips).toFixed(0) + ' pips\n';
            csv += 'å¹³å‡åˆ©ç›Š,' + (wins.length > 0 ? (totalWinPips / wins.length).toFixed(0) : 0) + ' pips\n';
            csv += 'å¹³å‡æå¤±,' + (losses.length > 0 ? (totalLossPips / losses.length).toFixed(0) : 0) + ' pips\n';
            
            if (streaks) {
                csv += 'æœ€å¤§é€£å‹æ•°,' + streaks.maxWinStreak + '\n';
                csv += 'æœ€å¤§é€£æ•—æ•°,' + streaks.maxLoseStreak + '\n';
            }
            
            csv += '\n=== æ¤œè¨¼è¨˜éŒ²è©³ç´° ===\n';
            csv += 'No,çµæœ,pips,ç†ç”±\n';

            records.forEach((record, index) => {
                const pipsValue = parseFloat(record.pips) || 0;
                csv += `${index + 1},`;
                csv += `${record.result === 'win' ? 'å‹ã¡' : record.result === 'lose' ? 'è² ã‘' : 'è¦‹é€ã‚Š'},`;
                csv += `${pipsValue !== 0 ? pipsValue.toFixed(1) : '-'},`;
                csv += `"${record.skipReason ? record.skipReason.replace(/"/g, '""') : '-'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `EdgeFinder_${currentTheme.pair || 'ãƒ‡ãƒ¼ã‚¿'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
